<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>영상 프롬프트 갤러리 + Poll</title>
  <style>
    :root { --maxw: 1200px; --sidebar-w: 330px; }
    body { font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:#111; background:#f8f9fb; }
    header, footer { background:#fff; border-bottom:1px solid #e5e7eb; }
    header { position:sticky; top:0; z-index:10; }
    .wrap { max-width:var(--maxw); margin:0 auto; padding:14px 16px; }
    h1 { font-size:18px; margin:0; }
    .meta { font-size:14px; color:#555; }

    .layout { display:flex; gap:16px; align-items:flex-start; }
    .sidebar {
      width:var(--sidebar-w); min-width:var(--sidebar-w);
      background:#fff; border:1px solid #e5e7eb; border-radius:14px;
      overflow:hidden; box-shadow:0 1px 2px rgba(0,0,0,.03);
      display:flex; flex-direction:column;
    }
    .sidebar .head { padding:10px 12px; border-bottom:1px solid #eef2f7; font-weight:700; font-size:14px; color:#374151; display:flex; justify-content:space-between; align-items:center;}
    .list { display:flex; flex-direction:column; padding:10px; gap:10px; max-height:60vh; overflow:auto; }
    .savePanel { margin-top:auto; border-top:1px solid #eef2f7; padding:10px; display:flex; gap:8px; align-items:center; }
    .savePanel .select { flex:1 1 auto; }

    /* 리스트 아이템: 좌측 정보(썸네일+모델명) 클릭 = 재생, 우측 버튼 = 순차 선택 */
    .item {
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px; border:1px solid #e5e7eb; border-radius:12px;
      background:#fff; transition:background .15s, border-color .15s;
    }
    .item:hover { background:#f7fafc; }
    .item.active { border-color:#111; background:#f0f2f5; }
    .info { display:flex; gap:10px; align-items:center; flex:1 1 auto; cursor:pointer; }
    .thumbBox { width:110px; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; flex-shrink:0; }
    .thumb { width:100%; height:100%; object-fit:cover; display:block; }
    .label { font-size:14px; color:#111; font-weight:700; }

    /* 우측 순위 선택 영역 */
    .rankCol { display:flex; align-items:center; gap:8px; flex-shrink:0; }
    .rankTag { font-size:12px; font-weight:700; color:#2563eb; min-width:22px; text-align:center; }
    .rankBtn {
      border:1px solid #d1d5db; background:#f9fafb; color:#374151;
      font-size:12px; padding:4px 8px; border-radius:6px; cursor:pointer;
    }
    .rankBtn[disabled] { opacity:.55; cursor:not-allowed; }
    .undoBtn { border:1px solid #ef4444; color:#ef4444; background:#fff; }

    .viewer { flex:1 1 auto; display:flex; flex-direction:column; gap:10px; }
    .viewerBox {
      width:100%; max-width:1080px; aspect-ratio:16/9;
      border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#000;
      box-shadow:0 1px 2px rgba(0,0,0,.03);
    }
    iframe.viewerFrame { width:100%; height:100%; border:0; display:block; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { border:1px solid #111; background:#111; color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn.outline { background:#fff; color:#111; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .select { padding:6px 10px; border-radius:10px; border:1px solid #d1d5db; background:#fff; }
    .hint { font-size:12px; color:#6b7280; }

    /* 모바일 대응 */
    @media (max-width:640px){
      :root{--sidebar-w:100%;}
      .wrap{padding:10px 12px;}
      h1{font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw;}
      #metaText{display:none;}
      .controls{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto auto;gap:8px;width:100%;}
      #prevBtn{grid-column:1/2;}
      #nextBtn{grid-column:2/3;}
      #promptSelector{grid-column:1/-1;max-width:100%;font-size:14px;}
      .layout{flex-direction:column;gap:12px;}
      .sidebar{width:100%;min-width:0;}
      .viewerBox{max-width:100%;}
      .list{max-height:44vh;}
      .thumbBox{width:120px;}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
    <div>
      <h1>영상 프롬프트 갤러리</h1>
      <div class="meta" id="metaText">Loading…</div>
    </div>
    <div class="controls">
      <button class="btn outline" id="prevBtn">이전</button>
      <select class="select" id="promptSelector" aria-label="프롬프트 선택"></select>
      <button class="btn" id="nextBtn">다음</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:12px;">
  <div class="layout">
    <aside class="sidebar">
      <div class="head">
        <span>영상 목록 (우측 버튼으로 순차 지정)</span>
        <span class="hint" id="progressHint">0/5</span>
      </div>
      <div id="list" class="list" aria-live="polite"></div>

      <!-- 좌측 하단 저장 영역 -->
      <div class="savePanel">
        <input id="respondentInput" type="text" class="select" placeholder="이름 (필수-이벤트응모)">
        <button class="btn" id="submitBtn" disabled>저장</button>
      </div>
    </aside>

    <section class="viewer">
      <div class="viewerBox" id="viewerBox"></div>
      <div id="noteBox" class="hint"></div>
      <div class="hint">썸네일/모델명 영역 클릭 → 우측에서 재생 · 가장 품질이 좋은 모델부터 순서대로 <b>순위지정</b> 버튼을 누르면 1위부터 순차적으로 평가 됨 · <b>선택취소</b>는 직전 순위지정만 가능</div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;padding-bottom:14px;">
    <div class="hint">GitHub Pages · Google Form Poll</div>
    <div class="hint">↑↓ 영상 이동 · ←→ 프롬프트 이동</div>
  </div>
</footer>

<script>
const INDEX_URL='prompts/index.json';
const FORM_ACTION='https://docs.google.com/forms/d/e/1FAIpQLSdM9-XgDDEj6ger_I6CnpnUo6xi0OOBoJH3fuVcSweapVnyLA/formResponse';
// const ENTRY={
//  respondent:'entry.1754968065',
//  prompt:'entry.687308874',
  //SORA:'entry.1657125172',
//  VEO3:'entry.1802394734',
//  LUMALabs:'entry.675826076',
//  'WAN2.2':'entry.1513721864',
//  'LTX-Video':'entry.360849732',
//  order:'entry.783496875'
//};

const ENTRY = {
  respondent: 'entry.577493348',   // Name
  prompt:     'entry.1100587388',  // Prompt_ID
  SORA:       'entry.590964581',
  VEO3:       'entry.594922169',
  LUMALabs:   'entry.329427994',
  'WAN v2.2': 'entry.710987574',
  'LTX-Video':'entry.1025399171',
  order:      'entry.1770970872'   // OrderString
};




let indexData={prompts:[]};
let curPrompt=0,curList=[],curVideoIdx=0;

// 순차 선택 스택 (LIFO). 항목은 {idx, label}
let ranking=[];

const savedName = localStorage.getItem('respondentName')||'';
document.addEventListener('DOMContentLoaded', ()=> { document.getElementById('respondentInput').value=savedName; });

const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];

function ytEmbed(id,autoplay=false){
  const q = ['rel=0','modestbranding=1','playsinline=1','mute=1','loop=1','playlist='+id];
  if (autoplay) q.push('autoplay=1');
  return `https://www.youtube.com/embed/${id}?${q.join('&')}`;
}
function ytThumb(id){return `https://i.ytimg.com/vi/${id}/default.jpg`;}

function clearViewer(){qs('#viewerBox').innerHTML='';}
function mountViewer(id,label,autoplay=false){
  qs('#viewerBox').innerHTML=`<iframe class="viewerFrame" src="${ytEmbed(id,autoplay)}"
    title="${label||''}" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture;web-share" allowfullscreen></iframe>`;
}
function selectVideo(i,autoplay=true){
  if(!curList.length) return;
  curVideoIdx=i;
  const v=curList[i];
  mountViewer(v.id,v.label,autoplay);
  highlightActive();
}
function highlightActive(){
  qsa('.item').forEach(el=>el.classList.remove('active'));
  const act=qs(`.item[data-idx="${curVideoIdx}"]`); if (act) act.classList.add('active');
}

function getRankOfIdx(idx){
  const pos = ranking.findIndex(r=>r.idx===idx);
  return (pos>=0) ? pos+1 : null;
}
function isLastSelected(idx){
  if (!ranking.length) return false;
  return ranking[ranking.length-1].idx===idx;
}
function progressText(){
  return `${ranking.length}/${curList.length || 5}`;
}
function setSubmitEnabled(){
  const nameFilled = !!qs('#respondentInput').value.trim();
  const doneAll = ranking.length === curList.length && curList.length>0;
  qs('#submitBtn').disabled = !(nameFilled && doneAll);
  qs('#progressHint').textContent = progressText();
}

/* 순차 선택: 아직 선택 안된 아이템이면 push; 이미 선택된 아이템이면 "직전 선택"일 때만 pop */
function toggleSequential(idx,label){
  const pos = ranking.findIndex(r=>r.idx===idx);
  if (pos>=0){
    // 이미 선택됨 → 직전일 때만 취소
    if (pos === ranking.length-1){
      ranking.pop();
    } else {
      // 직전이 아니면 무시 (시각 피드백만)
      const btn = qs(`#rankBtn-${idx}`);
      if (btn){ btn.animate([{transform:'scale(1)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:180}); }
      return;
    }
  } else {
    if (ranking.length < curList.length){
      ranking.push({idx,label});
    }
  }
  renderList(false);
  setSubmitEnabled();
}

function renderList(reset=true){
  const listEl=qs('#list'); if(reset) listEl.innerHTML='';
  curList.forEach((v,i)=>{
    let row = qs(`.item[data-idx="${i}"]`);
    if (!row){
      row = document.createElement('div');
      row.className='item'; row.dataset.idx=i;
      row.innerHTML=`
        <div class="info">
          <div class="thumbBox"><img class="thumb" loading="lazy" src="${ytThumb(v.id)}" alt=""></div>
          <div class="label">${v.label||('Video '+(i+1))}</div>
        </div>
        <div class="rankCol">
          <span class="rankTag" id="rankTag-${i}"></span>
          <button class="rankBtn" id="rankBtn-${i}" type="button">순위지정</button>
          <button class="rankBtn undoBtn" id="undoBtn-${i}" type="button" style="display:none;">선택취소</button>
        </div>`;
      // 좌측 정보 클릭 -> 영상 재생만
      row.querySelector('.info').addEventListener('click', ()=>selectVideo(i, true));
      // 우측 선택/되돌리기
      row.querySelector(`#rankBtn-${i}`).addEventListener('click', (e)=>{ e.stopPropagation(); toggleSequential(i, v.label); });
      row.querySelector(`#undoBtn-${i}`).addEventListener('click', (e)=>{ e.stopPropagation(); toggleSequential(i, v.label); });
      listEl.appendChild(row);
    }
    // 상태 반영
    const r = getRankOfIdx(i);
    const tag = row.querySelector(`#rankTag-${i}`);
    const pickBtn = row.querySelector(`#rankBtn-${i}`);
    const undoBtn = row.querySelector(`#undoBtn-${i}`);

    tag.textContent = r ? `${r}위` : '';
    if (!r){ // 미선택
      pickBtn.disabled = (ranking.length>=curList.length); // 5개 꽉 차면 더 못 고름
      pickBtn.style.display = '';
      undoBtn.style.display = 'none';
    } else { // 선택됨
      // 직전 선택만 되돌리기 허용
      const last = isLastSelected(i);
      pickBtn.style.display = last ? 'none' : '';
      pickBtn.disabled = true;
      undoBtn.style.display = last ? '' : 'none';
    }
  });
  highlightActive();
}

function formatStructuredNote(str) {
  const lines = String(str||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  return lines.map(line=>{
    const m = line.match(/^(Setting|Action|Visuals|Camera|Mood|Duration)\s*:\s*(.*)$/i);
    if (m) return `<div><b>${m[1]}</b>: ${m[2]}</div>`;
    return `<div>${line}</div>`;
  }).join('');
}

async function renderPrompt(idx){
  if(idx<0) idx=0;
  if(idx>=indexData.prompts.length) idx=indexData.prompts.length-1;
  curPrompt = idx;
  qs('#metaText').textContent = `프롬프트 ${idx+1}/${indexData.prompts.length}`;

  // 초기화
  ranking = [];
  setSubmitEnabled();

  // 노트/비디오
  const item=indexData.prompts[idx];
  try{
    const res=await fetch(item.file,{cache:'no-store'});
    const payload=await res.json();
    curList = payload.videos || [];
    renderList(true);
    // 노트
    qs('#noteBox').innerHTML = payload.note ? formatStructuredNote(payload.note) : '';
    // 첫 항목 자동 재생 OFF
    if(curList[0]) selectVideo(0, false); else clearViewer();
  }catch(e){
    qs('#list').innerHTML = `<div class="hint" style="padding:10px;">로드 오류: ${e.message}</div>`;
    qs('#noteBox').textContent = '';
    clearViewer();
  }

  // 드롭다운/버튼 상태
  const sel=qs('#promptSelector'); if (sel.value!==String(idx)) sel.value=String(idx);
  qs('#prevBtn').disabled = (idx===0);
  qs('#nextBtn').disabled = (idx===indexData.prompts.length-1);
  setSubmitEnabled();
}

async function init(){
  // 인덱스 로드
  const res=await fetch(INDEX_URL,{cache:'no-store'});
  indexData=await res.json();
  if(!Array.isArray(indexData.prompts)) indexData.prompts=[];

  // 드롭다운 구성
  const sel=qs('#promptSelector'); sel.innerHTML='';
  indexData.prompts.forEach((p,i)=>{
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent=`${i+1}. ${p.title||''}`;
    o.title=p.title||'';
    sel.appendChild(o);
  });

  // 이벤트
  qs('#prevBtn').addEventListener('click',()=>renderPrompt(curPrompt-1));
  qs('#nextBtn').addEventListener('click',()=>renderPrompt(curPrompt+1));
  sel.addEventListener('change',e=>renderPrompt(parseInt(e.target.value,10)||0));

  // 이름(필수)
  const nameInput=qs('#respondentInput');
  nameInput.addEventListener('input', ()=>{ setSubmitEnabled(); });
  nameInput.addEventListener('blur', ()=> localStorage.setItem('respondentName', nameInput.value.trim()));

  // 저장
  qs('#submitBtn').addEventListener('click', submitPoll);

  await renderPrompt(0);
}

function currentPromptId(){
  const meta = indexData.prompts[curPrompt];
  return meta && meta.id ? meta.id : ('P'+(curPrompt+1));
}

async function submitPoll(){
  const respondent = qs('#respondentInput').value.trim();
  if (!respondent) { alert('이름은 필수입니다. (이벤트 응모)'); return; }
  if (ranking.length !== curList.length){ alert('5개 모두 순위를 지정해주세요.'); return; }
  localStorage.setItem('respondentName', respondent);

  // 모델별 랭크 맵 만들기
  const rankMap = new Map(); // idx -> rank(1..N)
  ranking.forEach((r, i)=> rankMap.set(r.idx, i+1));
  const orderString = curList.map((_,i)=>rankMap.get(i)||'').join('');

  const form = new URLSearchParams();
  form.append(ENTRY.respondent, respondent);
  form.append(ENTRY.prompt, currentPromptId());
  curList.forEach((v,i)=>{
    const ek = ENTRY[v.label];
    if (ek) form.append(ek, String(rankMap.get(i)||'')); // 1..5
  });
  if (ENTRY.order) form.append(ENTRY.order, orderString);

  try{
    await fetch(FORM_ACTION, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body: form.toString()
    });
    alert('저장 완료! 시트에서 확인하세요.');
  }catch(e){
    console.error(e);
    alert('저장 중 오류가 발생했습니다. 다시 시도해주세요.');
  }
}

init();
</script>
</body>
</html>
